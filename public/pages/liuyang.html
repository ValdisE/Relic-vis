<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>浏阳古乐</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            user-select: none;
        }

        html,
        body,
        svg {
            height: 100%;
            width: 100%;
        }
    </style>
</head>

<body>
    <script src="../javascripts/d3.min.js"></script>
    <script>
        /*----------------------------------*
         * Global variables
         *----------------------------------*/
        let instruments = [], // 所有待选文物
            current_inst = {
                inst: null,
                graphics: {
                    circle: null,
                    text: null
                }
            }, // 当前在展示的文物
            svg,
            instrument_sum,
            centerX, centerY,
            r1, r2, r3, r4,
            graphics = {
                base_frame: [],
                interacts: {
                    inst_icons: [],
                    material_icons: [],
                    number_icons: [],
                    current: {
                        material_icon: null,
                        inst_icon: null,
                        name_icon: null
                    }
                }
            };

        /*----------------------------------*
         * Data Structure
         *----------------------------------*/
        class Instrument {
            constructor(config) {
                this.index = config.index;
                this.name = config.name;
                this.material = config.material;
                this.number = config.number | 0;
                this.graphics = {
                    icon: null,
                    background: null,
                    name: null
                }
            }
            static change(newIndex, oldIndex) {
                // update current instrument
                current_inst.inst = instruments[newIndex];
                current_inst.graphics.text.text(instruments[newIndex].material);

                // 背景高亮调整
                instruments[oldIndex].graphics.background.attr("fill", "#DFDFDF");
                instruments[newIndex].graphics.background.attr("fill", "#AFAFAF");
            }
        }

        /*----------------------------------*
         * Initialize
         *----------------------------------*/
        function initialize(data) {
            svg = d3.select("body").append("svg");
            for (let i = 0; i < data.length; i++) {
                instruments.push(new Instrument({
                    index: i,
                    name: data[i].name,
                    material: data[i].material,
                    number: data[i].number,
                }));
            }
            current_inst.inst = instruments[0]; // 浅拷贝
            // current_inst.graphics.text

            instrument_sum = instruments.length;
            centerX = window.innerWidth / 3;
            centerY = window.innerHeight / 2;
            r1 = 125;
            r2 = 150;
            r3 = 230;
            r4 = 330;
            graphics.base_frame = [
                svg.append("circle")
                .attr("cx", centerX)
                .attr("cy", centerY)
                .attr("r", r1)
                .attr("stroke", "#EAEAEA")
                .attr("stroke-width", "1")
                .attr("fill", "transparent"),
                svg.append("circle")
                .attr("cx", centerX)
                .attr("cy", centerY)
                .attr("r", r2)
                .attr("stroke", "#E5E5E5")
                .attr("stroke-width", "30")
                .attr("fill", "transparent"),
                svg.append("circle")
                .attr("cx", centerX)
                .attr("cy", centerY)
                .attr("r", r3)
                .attr("stroke", "#EAEAEA")
                .attr("stroke-width", "1")
                .attr("fill", "transparent"),
                svg.append("circle")
                .attr("cx", centerX)
                .attr("cy", centerY)
                .attr("r", r4)
                .attr("stroke", "#EAEAEA")
                .attr("stroke-width", "1")
                .attr("fill", "transparent")
            ];
            for (let i = 0; i < instrument_sum; i++) {
                let cx4 = centerX + r4 * Math.cos(i / instrument_sum * 2 * Math.PI),
                    cy4 = centerY + r4 * Math.sin(i / instrument_sum * 2 * Math.PI),
                    cx2 = centerX + r3 * Math.cos(i / instrument_sum * 2 * Math.PI),
                    cy2 = centerY + r3 * Math.sin(i / instrument_sum * 2 * Math.PI),
                    cx3 = (cx2 + cx4) / 2,
                    cy3 = (cy2 + cy4) / 2,
                    cx1 = centerX + r2 * Math.cos(i / instrument_sum * 2 * Math.PI),
                    cy1 = centerY + r2 * Math.sin(i / instrument_sum * 2 * Math.PI);
                // Line frame
                graphics.base_frame.push(svg.append("line")
                    .attr("x1", centerX)
                    .attr("y1", centerY)
                    .attr("x2", cx4)
                    .attr("y2", cy4)
                    .attr("stroke", "#E7E7E7")
                    .attr("stroke-width", 1));

                // Instrument circle
                instruments[i].graphics.background = svg.append("circle")
                    .attr("cx", cx4)
                    .attr("cy", cy4)
                    .attr("r", 30)
                    .attr("fill", "#DFDFDF")
                    .attr("index", i)
                    .on("mousemove", function () {
                        this.style.cursor = "pointer";
                    })
                    .on("click", function () {
                        Instrument.change(this.getAttribute('index'), current_inst.inst.index);
                    });
                instruments[i].graphics.name = svg.append("text")
                    .attr("x", cx4 - 50)
                    .attr("y", cy4 - 30)
                    .attr("font-size", 10)
                    .attr('text-anchor', "right")
                    .text(instruments[i].name);

                // Number circle
                svg.append("circle")
                    .attr("cx", cx2)
                    .attr("cy", cy2)
                    .attr("r", 2 * Math.log2(instruments[i].number + 1))
                    .attr("fill", "#3C3040");
                svg.append("text")
                    .attr("x", cx2)
                    .attr("y", cy2 + 2)
                    .attr("font-size", 7)
                    .attr('text-anchor', "middle")
                    .attr('fill', '#FFF')
                    .text(instruments[i].number);

                // Material circle
                svg.append("circle")
                    .attr("cx", cx3)
                    .attr("cy", cy3)
                    .attr("r", 6)
                    .attr("stroke-width", 1.5)
                    .attr("stroke", "#CC3D3E")
                    .attr("fill", "#FFF");
                svg.append("text")
                    .attr("x", cx3)
                    .attr("y", cy3 + 2)
                    .attr("font-size", 7)
                    .attr('text-anchor', "middle")
                    .text(instruments[i].material);
            }
            // Current material circle
            current_inst.graphics.circle = svg.append("circle")
                .attr("cx", centerX + r2 * Math.cos(-75 / 360 * 2 * Math.PI))
                .attr("cy", centerY + r2 * Math.sin(-75 / 360 * 2 * Math.PI))
                .attr("r", 20)
                .attr("stroke-width", 3)
                .attr("stroke", "#CC3D3E")
                .attr("fill", "#FFF");
            current_inst.graphics.text = svg.append("text")
                .attr("x", centerX + r2 * Math.cos(-75 / 360 * 2 * Math.PI))
                .attr("y", centerY + r2 * Math.sin(-75 / 360 * 2 * Math.PI) + 6)
                .attr("font-size", 18)
                .attr('text-anchor', "middle")
                .text(instruments[0].material);
        }

        // Load json data
        d3.json("../json/instruments.json").then(function (data) {
            initialize(data);

        });

        // d3.xml("../images/svg/七弦琴.svg").mimeType("image/svg+xml").get(function (error, xml) {
        //     if (error) throw error;
        //     console.log(xml.documentElement);
        // });
    </script>
</body>

</html>